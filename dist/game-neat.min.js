var Game=function(){"use strict";function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function s(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}function a(t){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function c(t,e){return(c=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function u(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function r(t,e,n){return(r=u()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);i=new(Function.bind.apply(t,i));return n&&c(i,n.prototype),i}).apply(null,arguments)}function l(t){var i="function"==typeof Map?new Map:void 0;return(l=function(t){if(null===t||(e=t,-1===Function.toString.call(e).indexOf("[native code]")))return t;var e;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==i){if(i.has(t))return i.get(t);i.set(t,n)}function n(){return r(t,arguments,a(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),c(n,t)})(t)}function f(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function h(t,e){return y(t)||function(t,e){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(t)))return;var n=[],i=!0,r=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(i=(s=a.next()).done)&&(n.push(s.value),!e||n.length!==e);i=!0);}catch(t){r=!0,o=t}finally{try{i||null==a.return||a.return()}finally{if(r)throw o}}return n}(t,e)||p(t,e)||b()}function d(t){return function(t){if(Array.isArray(t))return k(t)}(t)||v(t)||p(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function y(t){if(Array.isArray(t))return t}function v(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}function p(t,e){if(t){if("string"==typeof t)return k(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?k(t,e):void 0}}function k(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function b(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function g(t,e,n){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return n}function t(e){var t=Object.keys(e),n=function(t){var e=t.alias,n=t.object;if(!(n instanceof Object))throw TypeError("Cannot register a non-object into DI!");{var i;Array.isArray(n)?(i=function(t){return y(t)||v(t)||p(t)||b()}(n),t=i[0],i=i.slice(1),this[e]=r(t,[this].concat(d(i)))):this[e]=new n(this)}}.bind(e),i=function(t){t=this[t];"function"==typeof t.onInit&&t.onInit(this)}.bind(e);return t.forEach(function(t){n({object:e[t],alias:t})}),t.forEach(i),{container:e,registerObject:n}}var m=[{axis:"x",side:"width"},{axis:"y",side:"height"}];function x(t,e){e.collisionList=t.filter(function(t){return t!==e&&(n=(t={gameObject:e,instance:t}).gameObject,i=t.instance,m.map(function(t){var e=t.axis,t=t.side;return n[e]>=i[e]-n.colliderSize[t]&&(n[e]<=i[e]+n.colliderSize[t]||i[e]+i.colliderSize[t]>=n[e])}).every(function(t){return t}));var n,i}),e.collisionList.length&&e.onCollision(e)}function n(){var h=this,d=this.gameObjectInstanceFactory.instances;Object.values(d).forEach(function(t){var i,r,o,e,n,s=t.x,a=t.y,c=t.sprite,u=t.spriteDimensions,l=u.width,f=u.height;n=(i=t).keyEvents,r=i.keyEventPressedKeys,o=i.keyUpEventPressedKeys,n.forEach(function(t){var e=t.key,n=t.callback,t=t.isKeyUp;(r.has(e)||t&&o.has(e))&&(n(i),o.delete(e))}),u=(e=t).horizontalSpeed,n=e.verticalSpeed,e.x+=u||0,e.y+=n||0,x(d,t),t.onRender(t),h.canvasContext.drawImage(c,s,a,l,f)})}function S(t){var e=t.strokeColor,n=t.fillColor,t=t.canvasContext;t.save(),e&&(t.strokeStyle=e),n&&(t.fillStyle=n)}function e(){o(this,e)}function w(i,r){d(i.mouseEvents).forEach(function(t){var e=h(t,2),t=e[0],n=e[1];"function"==typeof n&&r.addEventListener(t,function(t){return n({instance:i,event:t})})})}var C=new WeakSet,O=function(){function t(){o(this,t),C.add(this),this.isRendering=!1}return s(t,[{key:"onInit",value:function(t){var e=t.gameObjectInstanceFactory,t=t.draw;this.gameObjectInstanceFactory=e,this.draw=t}},{key:"setCanvas",value:function(t){t=t instanceof HTMLCanvasElement?t:document.querySelector(t);if(!t)throw TypeError("Canvas hasn't been found. Check if parameter is a Element or valid selector.");return this.canvasContext=t.getContext("2d")}},{key:"setBackground",value:function(t){var e=t.backgroundUrl,n=t.backgroundColor,i=t.verticalSpeed,r=void 0===i?0:i,i=t.horizontalSpeed,t=void 0===i?0:i,i=this.canvasContext.canvas;e&&(i.style.backgroundImage='url("'.concat(e,'")'),i.style.backgroundSize="contain"),n&&(i.style.backgroundColor=n),this.bgVerticalSpeed=r,this.bgHorizontalSpeed=t}},{key:"startRender",value:function(){this.isRendering=!0,g(this,C,j).call(this)}},{key:"stopRender",value:function(){this.isRendering=!1}},{key:"onRender",value:function(){}}]),t}(),j=function t(){var e=this;this.isRendering&&requestAnimationFrame(function(){(function(){var t=this.canvasContext;t.clearRect(0,0,t.canvas.clientWidth,t.canvas.clientHeight)}).call(e),function(){var t=this.canvasContext,e=(r=this.draw.settings).font,n=r.fontSize,i=r.strokeColor,r=r.fillColor;t.font="".concat(n,"px ").concat(e,", sans-serif"),t.fillStyle=r,t.strokeStyle=i}.call(e),function(){var a=this.canvasContext;Object.values(this.draw.textList).forEach(function(t){var n=t.content,e=t.x,i=t.y,r=t.fill,o=t.data,s=t.strokeColor,t=t.fillColor;Object.entries(o).forEach(function(t){var e=h(t,2),t=e[0],e=e[1];n=n.split("{".concat(t,"}")).join(e)}),S({strokeColor:s,fillColor:t,canvasContext:a}),r&&a.fillText(n,e,i),a.strokeText(n,e,i),a.restore()})}.call(e),function(){var s=this.canvasContext;Object.values(this.draw.rectList).forEach(function(t){var e=t.x1,n=t.x2,i=t.y1,r=t.y2,o=t.fill;S({strokeColor:t.strokeColor,fillColor:t.fillColor,canvasContext:s}),o&&s.fillRect(e,i,n,r),s.strokeRect(e,i,n,r),s.restore()})}.call(e),n.call(e),function(){var t=this.canvasContext.canvas,e=(n=t.style).backgroundPositionY,n=n.backgroundPositionX,e=parseInt(e||0)+this.bgVerticalSpeed,n=parseInt(n||0)+this.bgHorizontalSpeed;t.style.backgroundPositionY=e+"px",t.style.backgroundPositionX=n+"px"}.call(e),e.onRender(),g(e,C,t).call(e)})},E=function(){function a(t,e){o(this,a),this.x=t,this.y=e}return s(a,[{key:"interpolate",value:function(t,e){var n=this.x,i=this.y,r=t.x,o=t.y;1<e&&(e=1),e<=0&&(e=1e-7);var s=n<r,t=i<o,r=(s?r-n:n-r)*e,e=(t?o-i:i-o)*e;return new a(s?n+r:n-r,t?i+e:i-e)}}]),a}(),I=new WeakSet,L=new WeakSet,R=function(){function t(){o(this,t),L.add(this),I.add(this),this.x=0,this.y=0,this.spriteDimensions={},this.colliderSize={},this.keyEvents=[],this.mouseEvents=new Map,this.keyUpEventPressedKeys=new Set,this.keyEventPressedKeys=new Set}return s(t,[{key:"getPosition",value:function(){return new E(this.x,this.y)}},{key:"setPosition",value:function(t,e){this.x=t,this.y=e}},{key:"setRelativePosition",value:function(t,e){this.setPosition(this.x+t,this.y+e)}},{key:"setVerticalSpeed",value:function(t){this.verticalSpeed=t}},{key:"setHorizontalSpeed",value:function(t){this.horizontalSpeed=t}},{key:"setSpeed",value:function(t){this.setVerticalSpeed(t),this.setHorizontalSpeed(t)}},{key:"setSpriteDimensions",value:function(t,e){t=0<arguments.length&&void 0!==t?t:0,e=1<arguments.length&&void 0!==e?e:0;this.spriteDimensions.width=t,this.spriteDimensions.height=e}},{key:"setSprite",value:function(t,e){var n=this,i=1<arguments.length&&void 0!==e?e:{},e=i.widthMultiplier,r=void 0===e?1:e,e=i.heightMultiplier,o=void 0===e?1:e,e=i.colliderWidthMultiplier,s=void 0===e?1:e,i=i.colliderHeightMultiplier,a=void 0===i?1:i,c=new Image;return c.src=t,c.onload=function(){n.setSpriteDimensions(c.naturalWidth*r,c.naturalHeight*o),n.colliderSize.width=n.spriteDimensions.width*s,n.colliderSize.height=n.spriteDimensions.height*a},this.sprite=c}},{key:"isCollidingWith",value:function(e){return this.collisionList.some(function(t){return t===e||t.id===e})}},{key:"onCollision",value:function(){}},{key:"onRender",value:function(){}},{key:"onMouseMove",value:function(t){this.mouseEvents.set("mousemove",t)}},{key:"onClick",value:function(t){this.mouseEvents.set("click",t)}},{key:"onKey",value:function(t,e){var n=this;this.keyEvents.push({key:t,callback:e}),g(this,I,P).call(this,"keydown",t,function(){return n.keyEventPressedKeys.add(t)}),g(this,I,P).call(this,"keyup",t,function(){return n.keyEventPressedKeys.delete(t)})}},{key:"onKeyUp",value:function(t,e){var n=this;this.keyEvents.push({key:t,callback:e,isKeyUp:!0}),g(this,I,P).call(this,"keyup",t,function(){return n.keyUpEventPressedKeys.add(t)})}},{key:"isColliding",get:function(){return 0<this.collisionList.length}},{key:"isFreeXOnLeft",get:function(){var e=this;return g(this,L,F).call(this,function(t){return e.x<t.x})}},{key:"isFreeXOnRight",get:function(){var e=this;return g(this,L,F).call(this,function(t){return e.x>t.x})}},{key:"isFreeYOnTop",get:function(){var e=this;return g(this,L,F).call(this,function(t){return e.y<t.y})}},{key:"isFreeYOnBottom",get:function(){var e=this;return g(this,L,F).call(this,function(t){return e.y>t.y})}}]),t}(),P=function(t,e,n){document.body.addEventListener(t,function(t){t.key===e&&n(t)})},F=function(t){var e=this.collisionList;return 0<e.filter(t).length||0===e.length},A=function(){function t(){o(this,t)}return s(t,[{key:"onInit",value:function(t){t=t.gameObjectList;this.gameObjectList=t}},{key:"createObject",value:function(t,e){if(this.gameObjectList.hasOwnProperty(t)&&!e)throw Error("Game object with this id already exists.\nIf you want to create a new one with same id, pass true as a second parameter.");e=new R;return e.id=t,this.gameObjectList[t]=e}}]),t}(),T=new WeakSet,z=new WeakSet,M=function(){function t(){o(this,t),z.add(this),T.add(this)}return s(t,[{key:"onInit",value:function(t){var e=t.gameObjectList,n=t.gameObjectInstanceList,t=t.scene;this.gameObjectList=e,this.instances=n,this.scene=t}},{key:"createInstance",value:function(t){var e=this.gameObjectList,n=this.instances,t=e[t];if(t instanceof R){t=g(this,z,_).call(this,t);return n.push(t),t}}}]),t}(),_=function(t){var e=this.scene.canvasContext.canvas,t=Object.create(t);return t.collisionList=[],g(this,T,w).call(this,t,e),t},D=function(){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&c(t,e)}(r,l(Array));var n,i,e=(n=r,i=u(),function(){var t,e=a(n);return f(this,i?(t=a(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))});function r(){var t;return o(this,r),(t=e.call(this)).shift(),t}return s(r,[{key:"destroy",value:function(t){t=this.indexOf(t);return-1!==t&&(this.splice(t,1),!0)}},{key:"count",value:function(t){var n=t instanceof R?t.id:t;return this.reduce(function(t,e){return t+(e.id===n)},0)}},{key:"findInstancesBy",value:function(t){var e=t instanceof R?t.id:t;return this.filter(function(t){return t.id===e})}}]),r}(),K=function(i){return function(t){for(var e=0,n=this[i];void 0===t||n.hasOwnProperty(t)&&e<99999;)t=this.random.next(1,99999),++e;return t}},U=function(){function t(){o(this,t),this.settings={strokeColor:"#000",fillColor:"#000",fontSize:16,font:"Segoe UI"},this.textList={},this.rectList={},this.generateTextId=K("textList").bind(this),this.generateRectId=K("rectList").bind(this)}return s(t,[{key:"onInit",value:function(t){var e=t.scene,t=t.random;this.scene=e,this.random=t}},{key:"drawText",value:function(t){var e=t.content,n=t.x,i=t.y,r=t.fill,o=t.data,s=void 0===o?{}:o,a=t.strokeColor,o=t.fillColor,t=t.textId;return this.textList[t||this.generateTextId(t)]={content:e,x:n,y:i,fill:r,data:s,strokeColor:a,fillColor:o}}},{key:"drawRectangle",value:function(t){var e=t.x1,n=t.x2,i=t.y1,r=t.y2,o=t.fill,s=t.strokeColor,a=t.fillColor,t=t.rectId;return this.rectList[t||this.generateRectId(t)]={x1:e,x2:n,y1:i,y2:r,fill:o,strokeColor:s,fillColor:a}}},{key:"clearText",value:function(t){return delete this.textList[t]}},{key:"setFontSize",value:function(t){this.settings.fontSize=t}},{key:"setStrokeColor",value:function(t){this.settings.strokeColor=t}},{key:"setFillColor",value:function(t){this.settings.fillColor=t}},{key:"setStrokeAndFillColor",value:function(t){this.setStrokeColor(t),this.setFillColor(t)}},{key:"setFont",value:function(t){this.settings.font=t}}]),t}(),W=function(){function t(){o(this,t)}return s(t,[{key:"nextFloat",value:function(t,e){t=0<arguments.length&&void 0!==t?t:Number.MIN_SAFE_INTEGER,e=1<arguments.length&&void 0!==e?e:Number.MAX_SAFE_INTEGER;return t+Math.random()*(e-t)}},{key:"next",value:function(t,e){return Math.round(this.nextFloat(t,e))}}]),t}(),H=function(){function t(){o(this,t),this.sounds={}}return s(t,[{key:"addSound",value:function(t,e){this.sounds[t]=new Audio(e)}},{key:"playSound",value:function(t){this.sounds[t].play()}},{key:"stopSound",value:function(t){t=this.sounds[t];t.currentTime=0,t.pause()}},{key:"stopAllSounds",value:function(){Object.keys(this.sounds).forEach(this.stopSound.bind(this))}}]),t}();return function(){return t({draw:U,gameObjectFactory:A,gameObjectList:e,gameObjectInstanceList:D,gameObjectInstanceFactory:M,random:W,scene:O,sound:H}).container}}();
