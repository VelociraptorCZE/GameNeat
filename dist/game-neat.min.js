var Game=function(){"use strict";function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function n(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}function r(t,e){return(r=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function s(t,e,n){return(s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);var o=new(Function.bind.apply(t,i));return n&&r(o,n.prototype),o}).apply(null,arguments)}function l(t,e){return c(t)||function(t,e){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var n=[],i=!0,o=!1,r=void 0;try{for(var s,a=t[Symbol.iterator]();!(i=(s=a.next()).done)&&(n.push(s.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{i||null==a.return||a.return()}finally{if(o)throw r}}return n}(t,e)||f()}function a(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||u(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function c(t){if(Array.isArray(t))return t}function u(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function f(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function t(e){var t=Object.keys(e),n=function(t){var e=t.alias,n=t.object;if(!(n instanceof Object))throw TypeError("Cannot register a non-object into DI!");if(Array.isArray(n)){var i=function(t){return c(t)||u(t)||f()}(n),o=i[0],r=i.slice(1);this[e]=s(o,[this].concat(a(r)))}else this[e]=new n(this)}.bind(e),i=function(t){var e=this[t];"function"==typeof e.onInit&&e.onInit(this)}.bind(e);return t.forEach(function(t){n({object:e[t],alias:t})}),t.forEach(i),{container:e,registerObject:n}}var h=[{axis:"x",side:"width"},{axis:"y",side:"height"}];function v(t,n){n.collisionList=t.filter(function(t){return t!==n&&(i=(e={gameObject:n,instance:t}).gameObject,o=e.instance,h.map(function(t){var e=t.axis,n=t.side;return i[e]>=o[e]-i.objectSize[n]&&(i[e]<=o[e]+i.objectSize[n]||o[e]+o.objectSize[n]>=i[e])}).every(function(t){return t}));var e,i,o}),n.collisionList.length&&n.onCollision()}function o(){var u=this,f=this.gameObjectInstanceFactory.instances;Object.values(f).forEach(function(t){var e,n,i,o,r,s,a=t.x,c=t.y,l=t.sprite;n=(e=t).keyEvents,i=e.pressedKeys,n.forEach(function(t){var e=t.key,n=t.callback;i.has(e)&&n()}),r=(o=t).horizontalSpeed,s=o.verticalSpeed,o.x+=r||0,o.y+=s||0,v(f,t),u.canvasContext.drawImage(l,a,c)})}function y(t){var e=t.strokeColor,n=t.fillColor,i=t.canvasContext;i.save(),e&&(i.strokeStyle=e),n&&(i.fillStyle=n)}function d(){e(this,d)}function k(i){return function(t){for(var e=0,n=this[i];void 0===t||n.hasOwnProperty(t)&&e<99999;)t=this.random.next(1,99999),++e;return t}}var g=function(){function t(){e(this,t),this.setOnRenderCallback(),this.isRendering=!1}return n(t,[{key:"onInit",value:function(t){var e=t.gameObjectInstanceFactory,n=t.draw;this.gameObjectInstanceFactory=e,this.draw=n}},{key:"setCanvas",value:function(t){var e=t instanceof HTMLCanvasElement?t:document.querySelector(t);if(!e)throw TypeError("Canvas hasn't been found. Check if parameter is a Element or valid selector.");return this.canvasContext=e.getContext("2d")}},{key:"setBackground",value:function(t){var e=t.backgroundUrl,n=t.backgroundColor,i=t.verticalSpeed,o=void 0===i?0:i,r=t.horizontalSpeed,s=void 0===r?0:r,a=this.canvasContext.canvas;e&&(a.style.backgroundImage='url("'.concat(e,'")'),a.style.backgroundSize="contain"),n&&(a.style.backgroundColor=n),this.bgVerticalSpeed=o,this.bgHorizontalSpeed=s}},{key:"startRender",value:function(){this.isRendering=!0,this.onRender()}},{key:"stopRender",value:function(){this.isRendering=!1}},{key:"setOnRenderCallback",value:function(t){var e=0<arguments.length&&void 0!==t?t:function(){};this._onRenderCallback=e}},{key:"onRender",value:function(){var t=this;this.isRendering&&requestAnimationFrame(function(){(function(){var t=this.canvasContext;t.clearRect(0,0,t.canvas.clientWidth,t.canvas.clientHeight)}).call(t),function(){var t=this.canvasContext,e=this.draw.settings,n=e.font,i=e.fontSize,o=e.strokeColor,r=e.fillColor;t.font="".concat(i,"px ").concat(n,", sans-serif"),t.fillStyle=r,t.strokeStyle=o}.call(t),function(){var c=this.canvasContext;Object.values(this.draw.textList).forEach(function(t){var o=t.content,e=t.x,n=t.y,i=t.fill,r=t.data,s=t.strokeColor,a=t.fillColor;Object.entries(r).forEach(function(t){var e=l(t,2),n=e[0],i=e[1];o=o.split("{".concat(n,"}")).join(i)}),y({strokeColor:s,fillColor:a,canvasContext:c}),i&&c.fillText(o,e,n),c.strokeText(o,e,n),c.restore()})}.call(t),function(){var s=this.canvasContext;Object.values(this.draw.rectList).forEach(function(t){var e=t.x1,n=t.x2,i=t.y1,o=t.y2,r=t.fill;y({strokeColor:t.strokeColor,fillColor:t.fillColor,canvasContext:s}),r&&s.fillRect(e,i,n,o),s.strokeRect(e,i,n,o),s.restore()})}.call(t),o.call(t),function(){var t=this.canvasContext.canvas,e=t.style,n=e.backgroundPositionY,i=e.backgroundPositionX;n=parseInt(n||0)+this.bgVerticalSpeed,i=parseInt(i||0)+this.bgHorizontalSpeed,t.style.backgroundPositionY=n+"px",t.style.backgroundPositionX=i+"px"}.call(t),t._onRenderCallback(),t.onRender()})}}]),t}(),b=function(){function t(){e(this,t),this.x=0,this.y=0,this.objectSize={}}return n(t,[{key:"setPosition",value:function(t,e){this.x=t,this.y=e}},{key:"setRelativePosition",value:function(t,e){this.setPosition(this.x+t,this.y+e)}},{key:"setVerticalSpeed",value:function(t){this.verticalSpeed=t}},{key:"setHorizontalSpeed",value:function(t){this.horizontalSpeed=t}},{key:"setSpeed",value:function(t){this.setVerticalSpeed(t),this.setHorizontalSpeed(t)}},{key:"setObjectSize",value:function(t,e){var n=0<arguments.length&&void 0!==t?t:0,i=1<arguments.length&&void 0!==e?e:0;this.objectSize.width=n,this.objectSize.height=i}},{key:"setSprite",value:function(t,e){var n=this,i=1<arguments.length&&void 0!==e?e:{},o=i.widthMultiplier,r=void 0===o?1:o,s=i.heightMultiplier,a=void 0===s?1:s,c=new Image;return c.src=t,c.onload=function(){return n.setObjectSize(c.naturalWidth*r,c.naturalHeight*a)},this.sprite=c}},{key:"onCollision",value:function(){}},{key:"onKeyEvent",value:function(t,e,n){document.body.addEventListener(t,function(t){t.key===e&&n(t)})}},{key:"isCollidingWith",value:function(e){return this.collisionList.some(function(t){return t===e||t.id===e})}},{key:"_isFree",value:function(t){var e=this.collisionList;return 0<e.filter(t).length||0===e.length}},{key:"onKey",value:function(t,e){var n=this.keyEvents,i=this.pressedKeys;n.push({key:t,callback:e}),this.onKeyEvent("keydown",t,function(){return i.add(t)}),this.onKeyEvent("keyup",t,function(){return i.delete(t)})}},{key:"onKeyDown",value:function(t,e){this.onKeyEvent("keydown",t,e)}},{key:"onKeyUp",value:function(t,e){this.onKeyEvent("keyup",t,e)}},{key:"isColliding",get:function(){return 0<this.collisionList.length}},{key:"isFreeXOnLeft",get:function(){var e=this;return this._isFree(function(t){return e.x<t.x})}},{key:"isFreeXOnRight",get:function(){var e=this;return this._isFree(function(t){return e.x>t.x})}},{key:"isFreeYOnTop",get:function(){var e=this;return this._isFree(function(t){return e.y<t.y})}},{key:"isFreeYOnBottom",get:function(){var e=this;return this._isFree(function(t){return e.y>t.y})}}]),t}(),p=function(){function t(){e(this,t)}return n(t,[{key:"onInit",value:function(t){var e=t.gameObjectList;this.gameObjectList=e}},{key:"createObject",value:function(t,e){if(this.gameObjectList.hasOwnProperty(t)&&!e)throw Error("Game object with this id already exists.\nIf you want to create a new one with same id, pass true as a second parameter.");var n=new b;return n.id=t,this.gameObjectList[t]=n}}]),t}(),x=function(){function t(){e(this,t),this.instances=[]}return n(t,[{key:"onInit",value:function(t){var e=t.gameObjectList;this.gameObjectList=e}},{key:"createInstance",value:function(t){var e=this.gameObjectList,n=this.instances,i=e[t];if(i instanceof b){var o=this._cloneObject(i);return n.push(o),o}}},{key:"removeInstance",value:function(t){var e=this.instances,n=e.indexOf(t);-1!==n&&e.splice(n,1)}},{key:"_cloneObject",value:function(t){var e=Object.assign(new b,t);return e.pressedKeys=new Set,e.collisionList=[],e.keyEvents=[],e}}]),t}(),C=function(){function t(){e(this,t),this.settings={strokeColor:"#000",fillColor:"#000",fontSize:16,font:"Segoe UI"},this.textList={},this.rectList={},this.generateTextId=k("textList").bind(this),this.generateRectId=k("rectList").bind(this)}return n(t,[{key:"onInit",value:function(t){var e=t.scene,n=t.random;this.scene=e,this.random=n}},{key:"drawText",value:function(t){var e=t.content,n=t.x,i=t.y,o=t.fill,r=t.data,s=void 0===r?{}:r,a=t.strokeColor,c=t.fillColor,l=t.textId;return this.textList[l||this.generateTextId(l)]={content:e,x:n,y:i,fill:o,data:s,strokeColor:a,fillColor:c}}},{key:"drawRectangle",value:function(t){var e=t.x1,n=t.x2,i=t.y1,o=t.y2,r=t.fill,s=t.strokeColor,a=t.fillColor,c=t.rectId;return this.rectList[c||this.generateRectId(c)]={x1:e,x2:n,y1:i,y2:o,fill:r,strokeColor:s,fillColor:a}}},{key:"clearText",value:function(t){return delete this.textList[t]}},{key:"setFontSize",value:function(t){this.settings.fontSize=t}},{key:"setStrokeColor",value:function(t){this.settings.strokeColor=t}},{key:"setFillColor",value:function(t){this.settings.fillColor=t}},{key:"setStrokeAndFillColor",value:function(t){this.setStrokeColor(t),this.setFillColor(t)}},{key:"setFont",value:function(t){this.settings.font=t}}]),t}(),S=function(){function t(){e(this,t)}return n(t,[{key:"nextFloat",value:function(t,e){var n=0<arguments.length&&void 0!==t?t:Integer.MIN_SAFE_INTEGER,i=1<arguments.length&&void 0!==e?e:Integer.MAX_SAFE_INTEGER;return n+Math.random()*(i-n)}},{key:"next",value:function(t,e){return Math.round(this.nextFloat(t,e))}}]),t}(),m=function(){function t(){e(this,t),this.sounds={}}return n(t,[{key:"addSound",value:function(t,e){this.sounds[t]=new Audio(e)}},{key:"playSound",value:function(t){this.sounds[t].play()}},{key:"stopSound",value:function(t){var e=this.sounds[t];e.currentTime=0,e.pause()}},{key:"stopAllSounds",value:function(){Object.keys(this.sounds).forEach(this.stopSound.bind(this))}}]),t}();return function(){return t({draw:C,gameObjectFactory:p,gameObjectList:d,gameObjectInstanceFactory:x,random:S,scene:g,sound:m}).container}}();
